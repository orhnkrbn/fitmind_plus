import 'dart:async';
import 'dart:convert';
import 'dart:io';

import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;

/// Ã–zel Ollama hata tipi - UI'da yakalayÄ±p mesaj gÃ¶sterebiliriz.
class OllamaException implements Exception {
  final String message;
  OllamaException(this.message);

  @override
  String toString() => 'OllamaException: $message';
}

/// FitMind+ iÃ§in Ollama istemcisi.
/// 
/// KullanÄ±m:
/// ```dart
/// final client = OllamaClient();
/// try {
///   final response = await client.sendMessage('Merhaba!');
///   print(response);
/// } on OllamaException catch (e) {
///   print('Hata: ${e.message}');
/// }
/// ```
class OllamaClient {
  /// Ollama sunucu adresi (Ã¶rn: http://localhost:11434)
  final String baseUrl;

  /// KullanÄ±lacak model adÄ± (Ã¶rn: "qwen2.5:1.5b", "llama3", "qwen3:4b")
  final String model;

  /// Zaman aÅŸÄ±mÄ± sÃ¼resi
  final Duration timeout;

  OllamaClient({
    this.baseUrl = 'http://localhost:11434',
    this.model = 'qwen2.5:1.5b', // KÃ¼Ã§Ã¼k ve hÄ±zlÄ± model (varsayÄ±lan)
    this.timeout = const Duration(seconds: 40),
  });

  /// KullanÄ±cÄ± mesajÄ±nÄ± Ollama'ya gÃ¶nderir ve yanÄ±tÄ± dÃ¶ndÃ¼rÃ¼r.
  /// 
  /// Sistem prompt otomatik olarak eklenir (fitness koÃ§u konteksti).
  /// 
  /// Hata durumlarÄ±nda [OllamaException] fÄ±rlatÄ±r:
  /// - Timeout
  /// - BaÄŸlantÄ± hatasÄ± (Ollama kapalÄ±)
  /// - HTTP 200 dÄ±ÅŸÄ± yanÄ±t
  /// - BoÅŸ veya geÃ§ersiz yanÄ±t
  /// - JSON parse hatasÄ±
  Future<String> sendMessage(String userMessage) async {
    final uri = Uri.parse('$baseUrl/api/generate');

    // FitMind+ fitness koÃ§u sistem promptu
    final systemPrompt = '''
Sen FitMind+ adÄ±nda TÃ¼rkÃ§e konuÅŸan bir fitness ve motivasyon koÃ§usun.
KullanÄ±cÄ±ya yaÄŸ yakÄ±mÄ±, kas geliÅŸimi ve mental gÃ¼Ã§lenme konularÄ±nda yardÄ±mcÄ± ol.
TÄ±bbi teÅŸhis koyma, ciddi saÄŸlÄ±k sorunlarÄ±nda doktora yÃ¶nlendir.

Cevap kurallarÄ±:
- KÄ±sa ve net cevaplar ver (max 3-4 cÃ¼mle)
- Motive edici ve pozitif ol
- TÃ¼rkÃ§e kullan
- Emoji kullanabilirsin ama abartma
''';

    final fullPrompt = '''
$systemPrompt

KULLANICI MESAJI:
$userMessage

CEVAP:''';

    final body = jsonEncode({
      'model': model,
      'prompt': fullPrompt,
      'stream': false,
      'options': {
        'num_predict': 256, // Maksimum 256 token yanÄ±t (kÄ±sa ve Ã¶z)
        'temperature': 0.7, // Dengeli yaratÄ±cÄ±lÄ±k
        'top_p': 0.9,
        'top_k': 40,
      },
    });

    http.Response response;

    // HTTP isteÄŸi ve temel hata yakalama
    try {
      debugPrint('ğŸ”µ Ollama isteÄŸi gÃ¶nderiliyor');
      debugPrint('   ğŸ“ URL: $uri');
      debugPrint('   ğŸ¤– Model: $model');
      debugPrint('   â±ï¸  Timeout: ${timeout.inSeconds}s');
      debugPrint('   ğŸ“ Prompt uzunluÄŸu: ${fullPrompt.length} karakter');
      
      response = await http
          .post(
            uri,
            headers: {'Content-Type': 'application/json'},
            body: body,
          )
          .timeout(
            timeout,
            onTimeout: () {
              throw TimeoutException(
                'Ollama ${timeout.inSeconds} saniye iÃ§inde yanÄ±t vermedi',
                timeout,
              );
            },
          );
          
      debugPrint('ğŸŸ¢ Ollama HTTP yanÄ±tÄ± alÄ±ndÄ±');
      debugPrint('   ğŸ“Š Status Code: ${response.statusCode}');
      debugPrint('   ğŸ“¦ Body uzunluÄŸu: ${response.body.length} karakter');
      
    } on TimeoutException {
      debugPrint('ğŸ”´ TIMEOUT HATASI');
      debugPrint('   â±ï¸  SÃ¼re: ${timeout.inSeconds}s');
      debugPrint('   ğŸ’¡ Ã‡Ã¶zÃ¼m: Model Ã§ok bÃ¼yÃ¼k olabilir, daha kÃ¼Ã§Ã¼k model dene');
      throw OllamaException(
        'Ollama ${timeout.inSeconds} saniye iÃ§inde cevap vermedi. '
        'Model Ã§ok bÃ¼yÃ¼k veya sistem yavaÅŸ olabilir. '
        'Daha kÃ¼Ã§Ã¼k bir model (Ã¶rn: qwen2.5:1.5b) kullanmayÄ± dene.',
      );
    } on SocketException catch (e) {
      debugPrint('ğŸ”´ BAÄLANTI HATASI');
      debugPrint('   ğŸŒ URL: $baseUrl');
      debugPrint('   âŒ Hata: ${e.message}');
      debugPrint('   ğŸ’¡ Ã‡Ã¶zÃ¼m: "ollama serve" Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin ol');
      throw OllamaException(
        'Ollama sunucusuna baÄŸlanÄ±lamadÄ± ($baseUrl). '
        'LÃ¼tfen kontrol et:\n'
        '1. Terminal\'de "ollama serve" Ã§alÄ±ÅŸÄ±yor mu?\n'
        '2. URL doÄŸru mu? (varsayÄ±lan: http://localhost:11434)\n'
        '3. Firewall engelliyor mu?',
      );
    } on FormatException catch (e) {
      debugPrint('ğŸ”´ FORMAT HATASI (istek gÃ¶nderme)');
      debugPrint('   âŒ Hata: $e');
      throw OllamaException(
        'Ä°stek formatÄ±nda hata oluÅŸtu: $e',
      );
    } catch (e) {
      debugPrint('ğŸ”´ BEKLENMEDÄ°K HATA (HTTP katmanÄ±)');
      debugPrint('   âŒ Hata: $e');
      debugPrint('   ğŸ” Tip: ${e.runtimeType}');
      throw OllamaException(
        'Beklenmeyen bir aÄŸ hatasÄ± oluÅŸtu: $e',
      );
    }

    // HTTP status kontrolÃ¼
    if (response.statusCode != 200) {
      debugPrint('ğŸ”´ HTTP HATA YANITI');
      debugPrint('   ğŸ“Š Status Code: ${response.statusCode}');
      debugPrint('   ğŸ“„ Body: ${response.body.substring(0, response.body.length > 200 ? 200 : response.body.length)}...');
      
      String errorMessage = 'HTTP ${response.statusCode} hatasÄ±';
      
      // YaygÄ±n hata kodlarÄ±nÄ± aÃ§Ä±kla
      switch (response.statusCode) {
        case 404:
          errorMessage = 'Model bulunamadÄ± ($model). "ollama list" ile mevcut modelleri kontrol et.';
          break;
        case 500:
          errorMessage = 'Ollama sunucu hatasÄ±. Ollama loglarÄ±nÄ± kontrol et.';
          break;
        case 503:
          errorMessage = 'Ollama servisi kullanÄ±lamÄ±yor. Yeniden baÅŸlatmayÄ± dene.';
          break;
        default:
          errorMessage = 'Ollama HTTP ${response.statusCode} hatasÄ± dÃ¶ndÃ¼rdÃ¼.';
      }
      
      throw OllamaException(
        '$errorMessage\nDetay: ${response.body.length > 100 ? '${response.body.substring(0, 100)}...' : response.body}',
      );
    }

    // JSON parse ve yanÄ±t Ã§Ä±karma
    try {
      final data = jsonDecode(response.body) as Map<String, dynamic>;
      
      debugPrint('ğŸŸ¢ JSON parse baÅŸarÄ±lÄ±');
      debugPrint('   ğŸ”‘ Anahtarlar: ${data.keys.join(", ")}');
      
      // Ollama'nÄ±n farklÄ± API endpoint'leri farklÄ± alan isimleri kullanabiliyor
      final text = (data['response'] ?? 
                    data['message'] ?? 
                    data['text'] ?? 
                    data['content'] ??
                    '') as String;

      if (text.trim().isEmpty) {
        debugPrint('ğŸ”´ BOÅ YANIT');
        debugPrint('   ğŸ“„ Raw body: ${response.body}');
        debugPrint('   ğŸ’¡ Model dÃ¼zgÃ¼n Ã§alÄ±ÅŸmÄ±yor olabilir');
        throw OllamaException(
          'Ollama boÅŸ bir yanÄ±t dÃ¶ndÃ¼rdÃ¼. '
          'Model yÃ¼klÃ¼ mÃ¼? "ollama list" ve "ollama run $model" ile kontrol et.',
        );
      }

      debugPrint('âœ… BAÅARILI YANIT');
      debugPrint('   ğŸ“ Uzunluk: ${text.length} karakter');
      debugPrint('   ğŸ“„ Ã–nizleme: ${text.substring(0, text.length > 50 ? 50 : text.length)}...');
      
      return text.trim();
      
    } on FormatException catch (e) {
      debugPrint('ğŸ”´ JSON PARSE HATASI');
      debugPrint('   âŒ Hata: $e');
      debugPrint('   ğŸ“„ Body: ${response.body.substring(0, response.body.length > 200 ? 200 : response.body.length)}...');
      throw OllamaException(
        'Ollama yanÄ±tÄ± JSON formatÄ±nda deÄŸil. '
        'Beklenmeyen bir yanÄ±t alÄ±ndÄ±: ${response.body.substring(0, response.body.length > 100 ? 100 : response.body.length)}',
      );
    } catch (e) {
      debugPrint('ğŸ”´ PARSE SONRASI HATA');
      debugPrint('   âŒ Hata: $e');
      throw OllamaException(
        'YanÄ±t iÅŸlenirken hata oluÅŸtu: $e',
      );
    }
  }
}
